name: Deploy Multi-Framework Monorepo

on:
  push:
    branches: ["main"]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # --- Build Astro landing (root) ---
      - name: Build Landing Page (Astro)
        working-directory: ./astro
        run: |
          npm ci
          npm run build
      - run: |
          mkdir -p public
          cp -r astro/dist/* public/

      # --- Build all other subprojects ---
      - name: Build all subprojects
        run: |
          for dir in */ ; do
            if [ "$dir" != "astro/" ] && [ -f "$dir/package.json" ]; then
              echo "Building $dir..."
              cd "$dir"
              npm ci
              npm run build || echo "⚠️ Build failed in $dir"
              cd ..

              if [ -d "$dir/dist" ]; then
                cp -r "$dir/dist" "public/${dir%/}"
              elif [ -d "$dir/build" ]; then
                cp -r "$dir/build" "public/${dir%/}"
              else
                echo "⚠️ No se encontró carpeta dist/build en $dir"
              fi
            fi
          done

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          node-version: 20
          cache: npm
